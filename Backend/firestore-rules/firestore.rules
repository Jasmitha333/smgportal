rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Get user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check user role
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }
    
    // Check if user is employee
    function isEmployee() {
      return hasRole('employee');
    }
    
    // Check if user is admin
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Check if user is super admin
    function isSuperAdmin() {
      return hasRole('super_admin');
    }
    
    // Check if user is admin or super admin
    function isAdminOrAbove() {
      return isAdmin() || isSuperAdmin();
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Check if admin manages this department
    function managesDepartment(department) {
      return isAdmin() && department in getUserData().adminDepartments;
    }
    
    // ========================================
    // USERS COLLECTION
    // ========================================
    match /users/{userId} {
      // Read: Own profile OR admin/super-admin
      allow read: if isSignedIn() && (
        isOwner(userId) || 
        isSuperAdmin() || 
        (isAdmin() && managesDepartment(resource.data.department))
      );
      
      // Create: Allow authenticated users to create their own document OR super admin
      // TEMPORARY: This allows initial user setup
      allow create: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      
      // Update: Own profile (limited fields) OR super admin (all fields)
      allow update: if isSignedIn() && (
        (isOwner(userId) && onlyUpdatingAllowedFields()) ||
        isSuperAdmin()
      );
      
      // Delete: Only super admin
      allow delete: if isSuperAdmin();
      
      // Helper function for limited field updates by employees
      function onlyUpdatingAllowedFields() {
        let allowedFields = ['phone', 'emergencyContact', 'address', 'avatar', 'updatedAt'];
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
      }
    }
    
    // ========================================
    // ATTENDANCE COLLECTION
    // ========================================
    match /attendance/{userId}/records/{recordId} {
      // Read: Own records OR admin/super-admin
      allow read: if isSignedIn() && (
        isOwner(userId) ||
        isSuperAdmin() ||
        (isAdmin() && managesDepartment(resource.data.department))
      );
      
      // Create: Employee can create own records OR admin/super-admin
      allow create: if isSignedIn() && (
        (isOwner(userId) && request.resource.data.userId == userId) ||
        isAdminOrAbove()
      );
      
      // Update/Delete: Only admin or super admin
      allow update, delete: if isSuperAdmin() || isAdmin();
    }
    
    match /attendance/{userId}/monthlySummary/{summaryId} {
      // Read only, auto-generated by Cloud Functions
      allow read: if isSignedIn() && (isOwner(userId) || isAdminOrAbove());
      allow write: if false; // Only Cloud Functions can write
    }
    
    // ========================================
    // REQUESTS COLLECTION
    // ========================================
    match /requests/{requestId} {
      // Read: Own requests OR approver OR admin/super-admin
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        request.auth.uid in resource.data.approvers ||
        isSuperAdmin() ||
        (isAdmin() && managesDepartment(resource.data.department))
      );
      
      // Create: Any authenticated user
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Update: Owner can update pending requests OR approvers can approve/reject OR admin
      allow update: if isSignedIn() && (
        (resource.data.userId == request.auth.uid && resource.data.status == 'pending') ||
        (request.auth.uid in resource.data.approvers) ||
        isAdminOrAbove()
      );
      
      // Delete: Only super admin or owner if status is pending
      allow delete: if (
        isSuperAdmin() ||
        (resource.data.userId == request.auth.uid && resource.data.status == 'pending')
      );
    }
    
    // ========================================
    // TRAINING COLLECTION
    // ========================================
    match /training/sessions/{sessionId} {
      // Read: Everyone can view sessions
      allow read: if isSignedIn();
      
      // Create/Update/Delete: Only admin or super admin
      allow create, update, delete: if isAdminOrAbove();
    }
    
    match /training/enrollments/{enrollmentId} {
      // Read: Own enrollments OR admin/super-admin
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdminOrAbove()
      );
      
      // Create: Any user can enroll
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Update: Admin or super admin (for marking attendance, issuing certificates)
      allow update: if isAdminOrAbove();
      
      // Delete: Own enrollment if not completed OR admin/super-admin
      allow delete: if (
        (resource.data.userId == request.auth.uid && resource.data.enrollmentStatus != 'completed') ||
        isAdminOrAbove()
      );
    }
    
    match /training/userHistory/{userId}/courses/{courseId} {
      // Read: Own history OR admin/super-admin
      allow read: if isSignedIn() && (isOwner(userId) || isAdminOrAbove());
      
      // Write: Only Cloud Functions (auto-generated)
      allow write: if false;
    }
    
    // ========================================
    // ASSETS COLLECTION
    // ========================================
    match /assets/{assetId} {
      // Read: Everyone can view assets, assigned user, or admin
      allow read: if isSignedIn();
      
      // Create/Update/Delete: Only admin or super admin
      allow create, update, delete: if isAdminOrAbove();
    }
    
    // ========================================
    // DOCUMENTS COLLECTION
    // ========================================
    match /documents/{userId}/files/{documentId} {
      // Read: Owner OR shared users OR admin/super-admin
      allow read: if isSignedIn() && (
        isOwner(userId) ||
        request.auth.uid in resource.data.sharedWith ||
        isSuperAdmin() ||
        (isAdmin() && managesDepartment(get(/databases/$(database)/documents/users/$(userId)).data.department))
      );
      
      // Create: Owner or admin/super-admin
      allow create: if isSignedIn() && (
        isOwner(userId) ||
        isAdminOrAbove()
      );
      
      // Update/Delete: Owner or super-admin
      allow update, delete: if isOwner(userId) || isSuperAdmin();
    }
    
    // ========================================
    // PAYROLL COLLECTION
    // ========================================
    match /payroll/{userId}/records/{recordId} {
      // Read: Own records OR super admin
      allow read: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      
      // Write: Only super admin
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ========================================
    // SERVICES COLLECTIONS
    // ========================================
    
    // Transport
    match /services/transport/requests/{requestId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdminOrAbove()
      );
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdminOrAbove();
      allow delete: if isSuperAdmin();
    }
    
    // Canteen
    match /services/canteen/users/{userId} {
      allow read: if isSignedIn() && (isOwner(userId) || isAdminOrAbove());
      allow create: if isSuperAdmin();
      allow update: if isAdminOrAbove(); // For balance updates
      allow delete: if isSuperAdmin();
    }
    
    // Uniform
    match /services/uniform/requests/{requestId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdminOrAbove()
      );
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdminOrAbove();
      allow delete: if isSuperAdmin();
    }
    
    // SIM Card
    match /services/simcard/assignments/{simId} {
      allow read: if isSignedIn() && (
        resource.data.assignedTo == request.auth.uid ||
        isAdminOrAbove()
      );
      allow create, update, delete: if isAdminOrAbove();
    }
    
    // Guest House
    match /services/guesthouse/bookings/{bookingId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdminOrAbove()
      );
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdminOrAbove();
      allow delete: if isSuperAdmin();
    }
    
    // ========================================
    // NOTIFICATIONS COLLECTION
    // ========================================
    match /notifications/{userId}/messages/{notificationId} {
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: System (Cloud Functions) or admin/super-admin
      allow create: if isAdminOrAbove();
      
      // Update: Owner can mark as read
      allow update: if isOwner(userId) && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt']);
      
      // Delete: Owner or super admin
      allow delete: if isOwner(userId) || isSuperAdmin();
    }
    
    // ========================================
    // DEPARTMENTS COLLECTION
    // ========================================
    match /departments/{departmentId} {
      // Read: Everyone
      allow read: if isSignedIn();
      
      // Write: Only super admin
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ========================================
    // ANNOUNCEMENTS COLLECTION
    // ========================================
    match /announcements/{announcementId} {
      // Read: Everyone (filtered by targetAudience in app logic)
      allow read: if isSignedIn();
      
      // Create: Admin or super admin
      allow create: if isAdminOrAbove();
      
      // Update: Creator or super admin
      allow update: if (
        resource.data.publishedBy == request.auth.uid ||
        isSuperAdmin()
      );
      
      // Delete: Creator or super admin
      allow delete: if (
        resource.data.publishedBy == request.auth.uid ||
        isSuperAdmin()
      );
    }
  }
}
